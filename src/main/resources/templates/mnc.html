<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>all-in-one::emp-management</title>
    <style>
        body {
            margin-left: auto;
            margin-right: auto;
            margin-top: 10px;
            width: 80%;
        }
        .demo {
            font-family: sans-serif;
            border: 1px solid #eee;
            border-radius: 2px;
            padding: 20px 30px;
            margin-top: 1em;
            margin-bottom: 40px;
            user-select: none;
            overflow-x: auto;
        }
        .tab-button {
            padding: 6px 10px;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
            border: 1px solid #ccc;
            cursor: pointer;
            background: #f0f0f0;
            margin-bottom: -1px;
            margin-right: -1px;
        }
        .tab-button:hover {
            background: #e0e0e0;
        }
        .tab-button.active {
            background: #e0e0e0;
            height: 70px;
            margin: 2px 2px;
        }
        .tab {
            border: 1px solid #ccc;
            padding: 10px;
        }
        button.tab-button {
            height: 40px;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        * {
            margin-top: 5px;
            margin-bottom: 5px;
        }

    </style>
</head>
<body>
    <div id="app">
       <h1>{{ message }}</h1>
        <div class="demo">
            <button
                    v-for="(_, tab) in tabs"
                    :key="tab"
                    :class="['tab-button', { active: currentTab === tab }]"
                    @click="currentTab = tab">
                {{ tab }}
            </button>
            <hr/>
            <div class="tab">
                <component :is="tabs[currentTab]" ></component>
            </div>
        </div>
    </div>

    <template id="department">
        <strong>{{ title }}</strong>
        <p style="color: red;">{{ e }}</p>

        <div id="department__form">
            <form @submit.prevent="saveDepartment">
                <fieldset>
                    <legend>Create Department:</legend>
                    <label for="department__form__name">Name</label>
                    <br/>
                    <input id="department__form__name" placeholder="department Name" v-model="department.departmentName"/>
                    <br/>
                    <button type="submit">Ok</button>
                    <button type="reset">reset</button>
                </fieldset>
            </form>
        </div>
        <hr/>
        <div id="department__table">
            <p v-if="departments.length == 0">No data found</p>
            <table v-else>
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Name</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="dept in departments">
                        <td>{{ dept.departmentId}}</td>
                        <td>{{ dept.departmentName}}</td>
                        <td>
                            <button @click="deleteDepartment(dept.departmentId)">delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>
    <template id="job_title">
        <strong>{{ title }}</strong>
        <p style="color: red">{{ e }}</p>
        <form @submit.prevent="submitJobTitle">
            <fieldset>
                <legend>Create job Title</legend>
                <label for="job_title__title">Title</label><br/>
                <input type="text" id="job_title__title" v-model="jobTitle.title"/>
                <br/>
                <label for="job_title__minsalary">Min Salary</label><br/>
                <input type="number" id="job_title__minsalary" v-model="jobTitle.minSalary"/>
                <br/>
                <label for="job_title__maxsalary">Max Salary</label><br/>
                <input type="number" id="job_title__maxsalary" v-model="jobTitle.maxSalary">
                <br/>
                <button type="submit">Submit</button>
                <button type="reset">Reset</button>
            </fieldset>
        </form>
        <hr/>
        <p v-if="jobTitles.length === 0">No data found!</p>
        <table v-else>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Title</th>
                    <th>Min Salary</th>
                    <th>Max Salary</th>
                    <th>_</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="jt in jobTitles">
                    <td>{{ jt.jobId}}</td>
                    <td>{{ jt.title }}</td>
                    <td>{{ jt.minSalary }}</td>
                    <td>{{ jt.maxSalary }}</td>
                    <td>
                        <button>Delete</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </template>
    <template id="employee">
        <strong>{{ title }}</strong>
        <p style="color: red">{{ e }}</p>

        <form @submit.prevent="saveEmployee">
            <fieldset>
                <legend>Create Employee:</legend>
                <label>First Name</label><br/>
                <input type="text" v-model="employee.firstName"/>
                <br/>
                <label>Last Name</label><br/>
                <input type="text" v-model="employee.lastName"/>
                <br/>
                <label>Email</label><br/>
                <input type="email" v-model="employee.email"/>
                <br/>
                <label>Phone Number</label><br/>
                <input type="tel" v-model="employee.phoneNumber"/>
                <br/>
                <label>Hire Date</label><br/>
                <input type="date" v-model="employee.hireDate"/>
                <br/>
                <label>Job Title</label><br/>
                <select v-model="employee.jobId">
                    <option disabled value="">Please select one</option>
                    <option v-for="jt in jobTitles" :value="jt.jobId">{{jt.title}}</option>
                </select>
                <br/>
                <label>Salary</label><br/>
                <input type="number" v-model="employee.salary"/>
                <br/>
                <label>Manager Id</label><br/>
                <input type="text" v-model="employee.managerId" disabled/>
                <br/>
                <label>Department Name</label><br/>
                <select v-model="employee.departmentId">
                    <option disabled value="">Please select one</option>
                    <option v-for="dept in departments" :value="dept.departmentId">{{dept.departmentName}}</option>
                </select>
                <br/>
                <hr/>
                <label>Start Date (<span style="color: gray">Employee History</span>)</label><br/>
                <input type="date" v-model="employee.employeeHistory.startDate"/>
                <hr/>
                <label>Employee Documents</label><br/>
                <input type="text" v-model="employee.employeeDocuments" disabled/>
                <hr/>
                <button type="submit">Ok</button>
                <button type="reset">Reset</button>
            </fieldset>
        </form>
        <hr/>
        <p v-if="employees.length === 0">no data found!</p>
        <table v-else>
            <thead>
                <tr>
                    <th v-for="k in Object.keys(employees[0])">{{k}}</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="e in employees">
                    <td v-for="k in Object.keys(employees[0])">{{e[k]}}</td>
                </tr>
            </tbody>
        </table>
    </template>
    <template id="employee__history">
        <strong>{{ title }}</strong>
        <p style="color: red">{{ e }}</p>
        <hr/>
        <p v-if="employeeHistories.length === 0">No data found!</p>
        <table v-else>
            <thead>
                <tr>
                    <th v-for="k in Object.keys(employeeHistories[0])">{{k}}</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="eh in employeeHistories">
                    <td v-for="k in Object.keys(employeeHistories[0])">{{ eh[k] }}</td>
                </tr>
            </tbody>
        </table>
    </template>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- pinia-->
    <script src="https://unpkg.com/vue-demi"></script>
    <script src="https://unpkg.com/pinia"></script>
    <!-- pinia-->

    <script>
        const {createApp, ref, onMounted, computed} = Vue
        const { createPinia, defineStore, storeToRefs } = Pinia
        const pinia = createPinia()
        const apiHost = 'http://localhost:8080'

        //store
        const departmentStore = defineStore('department', () => {
            const departments = ref([])
            const allDepartments = () => {
                fetch(`${apiHost}/db/department`)
                    .then(r => {
                        if (!r.ok) {
                            throw new Error(`HTTP error! Status: ${r.status}`);
                        } else {
                            return r.json();
                        }
                    })
                    .then(data => departments.value = data)
                    .catch(err => console.log(err))
            }
            return { departments, allDepartments }
        })

        const jobTitleStore = defineStore('jobTitle', () => {
            const jobTitles = ref([])
            const allJobTitle = () => {
                fetch(`${apiHost}/db/jobtitle`)
                    .then(response => {
                        if(!response.ok) {
                            throw new Error('GET api error')
                        } else {
                            return response.json()
                        }
                    })
                    .then(data => jobTitles.value = data)
                    .catch(err => console.log(err))
            }

            return {
                jobTitles, allJobTitle
            }
        })
        const employeeStore = defineStore('employee', () => {
            const employees = ref([])
            const employeeNames = computed(() => employees.value.map((e) => `${e.firstName} ${e.lastName}`))
            const allEmployee = () => {
                fetch(`${apiHost}/db/employee`)
                    .then(r => {
                        if(!r.ok)
                            throw new Error("Employee fetch error")
                        return r.json()
                    })
                    .then(data => employees.value = data)
                    .catch(err => e.value = err)
            }
            return {
                employees, employeeNames, allEmployee
            }
        })
        //reusable component <blog-post></blog-post>
        const BlogPost = {
            props: ['postTitle'],
            emits: ['updatePost'],
            template: `
              <h3>Blog Post {{ postTitle }}</h3>
            `
        }

        //vue app
        createApp({
            setup() {
                const message = ref('emp mgmt')
                const currentTab = ref('EMPLOYEE_HISTORY')
                const HOME = {template: `<p>Home</p>`}
                const DEPARTMENT = {
                    template: '#department',
                    setup() {
                        const title = ref('Department')
                        const departments = ref([])
                        const department = ref({})
                        const e = ref(null)

                        const saveDepartment = () => {
                            fetch(`${apiHost}/db/department`, {
                                method: 'POST',
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(department.value)
                            })
                                .then(r => {
                                    if (!r.ok) {
                                        throw new Error(`HTTP error! Status: ${r.status}`);
                                    } else {
                                        return r.json();
                                    }
                                })
                                .then(r => {
                                    department.value = {}
                                    allDepartment()
                                })
                                .catch(err => e.value = err)
                        }

                        const allDepartment = () => {
                            fetch(`${apiHost}/db/department`)
                                .then(r => {
                                    if (!r.ok) {
                                        throw new Error(`HTTP error! Status: ${r.status}`);
                                    } else {
                                        return r.json();
                                    }
                                })
                                .then(r => {
                                    departments.value = r
                                })
                                .catch(err => e.value = err)
                        }

                        const deleteDepartment = (id) => {
                            fetch(`${apiHost}/db/department/${id}`, {
                                method: 'DELETE'
                            })
                                .then(r => {
                                    if (!r.ok)
                                        throw new Error(`HTTP error! Status: ${r.status}`);
                                    allDepartment()
                                })
                                .catch(e => e.value = e)
                        }

                        onMounted(() => {
                            allDepartment()
                        })

                        return {
                            title, saveDepartment, department, departments, e, deleteDepartment
                        }
                    }
                }
                const JOB_TITLE = {
                    template: '#job_title',
                    setup() {
                        const title = ref('Job Title')
                        const jobTitle = ref({})
                        const jobTitles = ref([])
                        const e = ref(null)
                        const submitJobTitle = () => {
                            fetch(`${apiHost}/db/jobtitle`,{
                                method: 'POST',
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(jobTitle.value)
                            })
                                .then(r => {
                                    console.log(`r = ${r}`)
                                    if(!r.ok){
                                        throw new Error('POST api  error')
                                    } else {
                                        return r.json()
                                    }
                                })
                                .then(data => {
                                    console.log(data)
                                    jobTitle.value = {}
                                    allJobTitles()
                                })
                                .catch(err => e.value = err)
                        }
                        const allJobTitles = () => {
                            fetch(`${apiHost}/db/jobtitle`)
                                .then(response => {
                                    if(!response.ok) {
                                        throw new Error('GET api error')
                                    } else {
                                        return response.json()
                                    }
                                })
                                .then(data => jobTitles.value = data)
                                .catch(err => e.value= err)
                        }
                        onMounted(() => {
                            allJobTitles()
                        })

                        return {
                            title, jobTitle, jobTitles, e, submitJobTitle
                        }
                    }
                }
                const EMPLOYEE = {
                    template: '#employee',
                    setup() {
                        const title = ref('Employee')
                        //const employees = ref([])
                        const employee = ref({employeeHistory: {}})
                        const e = ref(null)
                        //usage of dept store
                        const deptStore = departmentStore();
                        const { allDepartments } = deptStore;
                        const { departments } = storeToRefs(deptStore)

                        //usage of jobTitle store
                        const jtStore = jobTitleStore();
                        const { allJobTitle } = jtStore
                        const { jobTitles } = storeToRefs(jtStore)

                        const empStore = employeeStore()
                        const { allEmployee } = empStore
                        const { employees, employeeNames } = storeToRefs(empStore)

                        const saveEmployee = () => {
                            //adjust employeeHistory entity
                            employee.value = {
                                ...employee.value,
                                employeeHistory : {
                                    ...employee.value.employeeHistory,
                                    jobId: employee.value.jobId,
                                    departmentId: employee.value.departmentId
                                }
                            }

                            console.log(employee.value)

                            fetch(`${apiHost}/db/employee`,{
                                method: 'POST',
                                headers: {"Content-Type": "application/json"},
                                body: JSON.stringify(employee.value)
                            })
                                .then(r => {
                                    if(!r.ok)
                                        throw new Error("Error during employee persist")
                                    return r.json()
                                })
                                .then(data => {
                                    console.log(data)
                                    employee.value = {employeeHistory: {}}
                                    allEmployee()
                                })
                                .catch(err => e.value = err)

                        }
                        /*const allEmployee = () => {
                            fetch(`${apiHost}/db/employee`)
                                .then(r => {
                                    if(!r.ok)
                                        throw new Error("Employee fetch error")
                                    return r.json()
                                })
                                .then(data => employees.value = data)
                                .catch(err => e.value = err)
                        }*/

                        onMounted(() => {
                            console.log('EMPLOYEE mounted')
                            allEmployee()
                            allDepartments();
                            allJobTitle();
                        })

                        return {
                            title, employees, employee, e, saveEmployee, departments, jobTitles, allEmployee
                        }
                    }
                }
                const EMPLOYEE_HISTORY = {
                    template: '#employee__history',
                    setup() {
                        const title = ref('Employee History')
                        const e = ref(null)
                        const employeeHistory = ref({})
                        const employeeHistories = ref([])

                        const saveEmployeeHistory = () => {

                        }
                        const allEmployeeHistory = () => {
                            fetch(`${apiHost}/db/employee/history`)
                                .then(response => {
                                    if(!response.ok) {
                                        throw new Error('GET api error')
                                    } else {
                                        return response.json()
                                    }
                                })
                                .then(data => employeeHistories.value = data)
                                .catch(err => e.value = err)
                        }

                        onMounted(() => {
                            allEmployeeHistory()
                        })
                        return {
                            title, e, employeeHistory, employeeHistories, saveEmployeeHistory, allEmployeeHistory
                        }
                    }
                }
                const EMPLOYEE_DOCUMENTS = {template: `<p>Employee Documents</p>`}
                const tabs = {HOME, DEPARTMENT, JOB_TITLE, EMPLOYEE, EMPLOYEE_HISTORY, EMPLOYEE_DOCUMENTS}
                return {
                    message, currentTab, tabs
                }
            },
            //register the external component
            components: {BlogPost}
        }).use(pinia).mount('#app')
    </script>
</body>
</html>